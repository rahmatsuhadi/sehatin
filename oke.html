<!DOCTYPE html>
<html lang="id" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Sehatin - Empathy-Driven Health</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#58CC02",
              primaryDark: "#46a302",
              secondary: "#1CB0F6",
              accent: "#FFC800",
              danger: "#ff4b4b",
              darkBg: "#0f172a",
              darkCard: "#1e293b",
              surface: "#f8fafc",
            },
            fontFamily: { sans: ["Poppins", "sans-serif"] },
            animation: {
              float: "float 3s ease-in-out infinite",
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
            keyframes: {
              float: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
            },
          },
        },
      };
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Poppins", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(229, 231, 235, 0.5);
      }
      .dark .glass-card {
        background: rgba(30, 41, 59, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .input-group input,
      .input-group select {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        font-weight: 500;
        transition: all 0.3s;
      }
      .input-group input:focus,
      .input-group select:focus {
        border-color: #58cc02;
        background: #fff;
        outline: none;
        box-shadow: 0 0 0 4px rgba(88, 204, 2, 0.1);
      }
      .dark .input-group input,
      .dark .input-group select {
        background: #334155;
        border-color: #475569;
        color: white;
      }
      .btn-press {
        transition: transform 0.1s;
      }
      .btn-press:active {
        transform: scale(0.96);
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .hide-scroll::-webkit-scrollbar {
        display: none;
      }
      .auth-bg {
        background-image: radial-gradient(#58cc02 0.8px, transparent 0.8px);
        background-size: 24px 24px;
      }
      .dark .auth-bg {
        background-image: radial-gradient(#334155 0.8px, transparent 0.8px);
      }
      .mascot-avatar {
        font-size: 2.5rem;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
      }

      /* Nutri-Score Bar Styles */
      .nutri-score-bar {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
        height: 12px;
        margin-top: 4px;
      }
      .ns-seg {
        flex: 1;
        margin-right: 2px;
        opacity: 0.3;
      }
      .ns-seg.active {
        opacity: 1;
        transform: scaleY(1.2);
      }
      .ns-a {
        background: #038d4a;
      }
      .ns-b {
        background: #86bc25;
      }
      .ns-c {
        background: #ffc800;
      }
      .ns-d {
        background: #ee8f00;
      }
      .ns-e {
        background: #e63312;
      }
    </style>
  </head>
  <body
    class="bg-surface text-gray-800 dark:bg-darkBg dark:text-gray-100 min-h-screen pb-24 transition-colors duration-300"
  >
    <div
      id="toast"
      class="fixed top-6 left-1/2 -translate-x-1/2 z-[150] transition-all duration-300 opacity-0 pointer-events-none transform -translate-y-5 w-[90%] max-w-sm"
    >
      <div
        class="glass-card shadow-2xl px-4 py-3 rounded-2xl flex items-center gap-3 border-l-4 border-primary"
      >
        <div id="toast-icon" class="bg-green-100 text-primary p-2 rounded-full">
          <i class="fas fa-check"></i>
        </div>
        <div>
          <h4 class="font-bold text-sm">Alvi Berkata:</h4>
          <p id="toast-msg" class="text-xs text-gray-500 dark:text-gray-300">
            Berhasil!
          </p>
        </div>
      </div>
    </div>

    <div
      id="auth-section"
      class="fixed inset-0 z-[100] auth-bg bg-white dark:bg-darkBg flex flex-col items-center justify-center p-6"
    >
      <div
        class="w-full max-w-sm bg-white/90 dark:bg-darkCard/90 backdrop-blur-xl p-8 rounded-[2.5rem] shadow-2xl border border-white/50 dark:border-gray-700 fade-in relative overflow-hidden"
      >
        <div class="absolute -top-6 -right-6 text-[8rem] opacity-10 rotate-12">
          ðŸ¥‘
        </div>
        <div class="text-center mb-6 relative z-10">
          <div class="mascot-avatar animate-float mb-2">ðŸ¥‘</div>
          <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">
            Sehatin<span class="text-primary">.</span>
          </h1>
          <p class="text-xs text-gray-500 font-medium">
            Digital Nutrition Platform
          </p>
        </div>
        <div id="login-form">
          <div class="space-y-4 input-group">
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 ml-1"
                >Email</label
              ><input
                type="email"
                id="login-email"
                placeholder="nama@email.com"
              />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 mb-1 ml-1"
                >Password</label
              ><input
                type="password"
                id="login-pass"
                placeholder="Password akun"
              />
            </div>
            <button
              onclick="handleLogin()"
              class="w-full bg-gradient-to-r from-primary to-green-500 text-white font-bold py-4 rounded-xl shadow-lg btn-press"
            >
              MASUK
            </button>
          </div>
          <p class="text-center mt-6 text-xs text-gray-500">
            Belum punya akun?
            <span
              onclick="toggleAuth('register')"
              class="text-primary font-bold cursor-pointer"
              >Daftar</span
            >
          </p>
        </div>
        <div id="register-form" class="hidden">
          <div class="space-y-3 input-group">
            <input type="text" id="reg-name" placeholder="Nama Lengkap" />
            <input type="email" id="reg-email" placeholder="Email" />
            <div>
              <input
                type="password"
                id="reg-pass"
                placeholder="Password (Min. 8 Karakter)"
              />
              <p class="text-[10px] text-gray-400 mt-1 ml-1">
                *Harus kombinasi huruf & angka
              </p>
            </div>
            <input
              type="password"
              id="reg-pass-confirm"
              placeholder="Konfirmasi Password"
            />
            <button
              onclick="handleRegister()"
              class="w-full bg-gradient-to-r from-secondary to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg btn-press"
            >
              DAFTAR AKUN
            </button>
          </div>
          <p class="text-center mt-6 text-xs text-gray-500">
            Sudah punya akun?
            <span
              onclick="toggleAuth('login')"
              class="text-secondary font-bold cursor-pointer"
              >Masuk</span
            >
          </p>
        </div>
      </div>
    </div>

    <div id="app-dashboard" class="hidden">
      <header
        class="fixed top-0 w-full z-40 bg-white/90 dark:bg-darkCard/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-5 py-4 flex justify-between items-center transition-all"
      >
        <div class="flex items-center gap-2" onclick="showPage('home')">
          <div
            class="w-8 h-8 bg-gradient-to-tr from-primary to-green-400 rounded-lg flex items-center justify-center text-white text-lg"
          >
            <i class="fas fa-leaf"></i>
          </div>
          <h1
            class="font-bold text-lg tracking-tight text-gray-800 dark:text-white"
          >
            Sehatin
          </h1>
        </div>
        <div class="flex items-center gap-3">
          <button
            onclick="toggleDarkMode()"
            class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-accent transition-colors btn-press"
          >
            <i class="fas fa-moon dark:hidden"></i
            ><i class="fas fa-sun hidden dark:block"></i>
          </button>
          <div
            class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden border-2 border-primary cursor-pointer"
            onclick="showPage('profile')"
          >
            <img
              src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix"
              class="w-full h-full object-cover"
            />
          </div>
        </div>
      </header>

      <main class="pt-24 px-4 container mx-auto max-w-md">
        <div id="page-home" class="page-section fade-in">
          <div class="flex justify-between items-start mb-6">
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">
                Hai,
                <span
                  id="home-username"
                  class="text-gray-900 dark:text-white font-bold"
                  >User</span
                >!
              </p>
              <h2 class="text-2xl font-extrabold text-gray-800 dark:text-white">
                Ayo Sehat! ðŸ¥‘
              </h2>
            </div>
            <div class="flex flex-col items-end">
              <div
                class="bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 px-3 py-1 rounded-full flex items-center gap-1 text-xs font-bold border border-orange-200 dark:border-orange-800 mb-1"
              >
                <i class="fas fa-fire text-orange-500 animate-pulse"></i>
                <span id="streak-count">0</span> Hari
              </div>
              <div class="flex gap-1">
                <div class="w-2 h-2 rounded-full bg-orange-400"></div>
                <div class="w-2 h-2 rounded-full bg-orange-400"></div>
                <div class="w-2 h-2 rounded-full bg-orange-400"></div>
                <div
                  class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-700"
                ></div>
                <div
                  class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-700"
                ></div>
              </div>
            </div>
          </div>

          <div
            class="mb-6 bg-gradient-to-br from-blue-600 to-indigo-600 p-5 rounded-[2rem] text-white shadow-lg relative overflow-hidden"
          >
            <div class="relative z-10">
              <div class="flex items-center gap-2 mb-2">
                <span
                  class="bg-white/20 text-[10px] font-bold px-2 py-0.5 rounded backdrop-blur"
                  >DIGITAL METABOLISM</span
                >
              </div>
              <p
                class="text-sm opacity-90 leading-relaxed"
                id="medical-context"
              >
                Halo! Berdasarkan data fisikmu, tubuhmu butuh asupan spesifik.
              </p>
              <div class="mt-3 flex gap-3">
                <div class="bg-white/20 backdrop-blur px-3 py-1.5 rounded-xl">
                  <p class="text-[10px] opacity-75">Target Kalori</p>
                  <p class="font-bold" id="ctx-cal">2000</p>
                </div>
                <div class="bg-white/20 backdrop-blur px-3 py-1.5 rounded-xl">
                  <p class="text-[10px] opacity-75">Berat Ideal</p>
                  <p class="font-bold" id="ctx-ideal">68 kg</p>
                </div>
              </div>
            </div>
            <i
              class="fas fa-dna absolute -bottom-4 -right-4 text-8xl text-white opacity-10"
            ></i>
          </div>

          <div
            class="bg-white dark:bg-darkCard rounded-[2rem] p-6 mb-6 shadow-sm border border-gray-100 dark:border-gray-700"
          >
            <div class="flex justify-between items-center mb-6">
              <div>
                <span class="text-sm text-gray-400">Sisa Kalori Harian</span>
                <div class="flex items-baseline gap-1">
                  <span
                    class="text-4xl font-bold tracking-tight text-gray-800 dark:text-white"
                    id="home-remaining-cals"
                    >0</span
                  ><span class="text-sm font-medium text-gray-400">kkal</span>
                </div>
              </div>
              <div class="relative w-16 h-16 flex items-center justify-center">
                <svg class="w-full h-full transform -rotate-90">
                  <circle
                    cx="32"
                    cy="32"
                    r="28"
                    stroke="#e2e8f0"
                    stroke-width="6"
                    fill="none"
                  />
                  <circle
                    id="cal-circle"
                    cx="32"
                    cy="32"
                    r="28"
                    stroke="#58CC02"
                    stroke-width="6"
                    fill="none"
                    stroke-dasharray="175"
                    stroke-dashoffset="175"
                    stroke-linecap="round"
                  /></svg
                ><i class="fas fa-utensils text-gray-400 absolute text-sm"></i>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-2.5">
                <p class="text-[10px] text-gray-400 uppercase font-bold">
                  Protein
                </p>
                <p class="font-bold text-base dark:text-white" id="home-pro">
                  0g
                </p>
                <div class="w-full bg-gray-200 h-1 rounded-full mt-1">
                  <div
                    id="bar-pro"
                    class="bg-blue-400 h-1 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-2.5">
                <p class="text-[10px] text-gray-400 uppercase font-bold">
                  Karbo
                </p>
                <p class="font-bold text-base dark:text-white" id="home-car">
                  0g
                </p>
                <div class="w-full bg-gray-200 h-1 rounded-full mt-1">
                  <div
                    id="bar-car"
                    class="bg-yellow-400 h-1 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="bg-gray-50 dark:bg-slate-800 rounded-xl p-2.5">
                <p class="text-[10px] text-gray-400 uppercase font-bold">
                  Lemak
                </p>
                <p class="font-bold text-base dark:text-white" id="home-fat">
                  0g
                </p>
                <div class="w-full bg-gray-200 h-1 rounded-full mt-1">
                  <div
                    id="bar-fat"
                    class="bg-red-400 h-1 rounded-full"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold text-lg text-gray-800 dark:text-white">
                Menu Hari Ini
              </h3>
              <button
                onclick="generateMealPlan()"
                class="text-primary text-xs font-bold uppercase tracking-wide bg-primary/10 px-3 py-1 rounded-full hover:bg-primary hover:text-white transition"
              >
                <i class="fas fa-magic mr-1"></i> Buat Menu
              </button>
            </div>
            <div id="meal-plan-container" class="space-y-3">
              <div
                class="p-6 text-center text-gray-400 text-sm bg-white dark:bg-darkCard rounded-2xl border border-dashed border-gray-300 dark:border-gray-700"
              >
                Belum ada rencana makan.
              </div>
            </div>
          </div>

          <div
            onclick="startScanFlow()"
            class="bg-gray-900 dark:bg-white text-white dark:text-gray-900 p-4 rounded-2xl shadow-xl flex items-center gap-4 cursor-pointer btn-press group mb-20 relative overflow-hidden"
          >
            <div
              class="absolute inset-0 bg-gradient-to-r from-transparent to-white/10 opacity-0 group-hover:opacity-100 transition-opacity"
            ></div>
            <div
              class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center text-2xl"
            >
              <i class="fas fa-camera"></i>
            </div>
            <div class="flex-1">
              <h4 class="font-bold text-lg">AI Nutrition Scan</h4>
              <p class="text-xs opacity-80">Analisis makro & cegah obesitas</p>
            </div>
            <i class="fas fa-chevron-right opacity-50"></i>
          </div>
        </div>

        <div id="page-stats" class="page-section hidden fade-in">
          <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">
            Analisis Data
          </h2>
          <div class="flex flex-col gap-4 mb-6">
            <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-xl flex gap-1">
              <button
                onclick="updateStatsView('calorie')"
                id="stat-tab-cal"
                class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-primary shadow-sm transition"
              >
                Kalori
              </button>
              <button
                onclick="updateStatsView('weight')"
                id="stat-tab-wei"
                class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition"
              >
                Berat Badan
              </button>
            </div>
            <div class="flex justify-end">
              <select
                id="stat-period"
                onchange="renderCharts()"
                class="bg-white dark:bg-darkCard border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1 text-xs font-bold"
              >
                <option value="daily">Harian</option>
                <option value="weekly">Mingguan</option>
                <option value="monthly">Bulanan</option>
              </select>
            </div>
          </div>
          <div
            class="bg-white dark:bg-darkCard p-4 rounded-[2rem] shadow-sm border border-gray-100 dark:border-gray-700 mb-6"
          >
            <div style="position: relative; height: 250px; width: 100%">
              <canvas id="mainChart"></canvas>
            </div>
          </div>
          <div
            class="bg-white dark:bg-darkCard p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6"
          >
            <h3 class="font-bold text-sm mb-3 text-gray-500 uppercase">
              Input Berat Badan
            </h3>
            <div class="flex gap-3">
              <input
                type="number"
                id="quick-weight-input"
                placeholder="Contoh: 65.5"
                class="input-style flex-1 border border-gray-200"
              /><button
                onclick="updateWeight()"
                class="bg-secondary text-white px-5 py-2 rounded-xl font-bold btn-press shadow-lg shadow-blue-500/30"
              >
                Simpan
              </button>
            </div>
          </div>
          <h3 class="font-bold text-lg mb-3" id="history-title">Riwayat</h3>
          <div id="history-list" class="space-y-2"></div>
        </div>

        <div id="page-library" class="page-section hidden fade-in pb-20">
          <div class="sticky top-24 bg-surface dark:bg-darkBg z-30 pb-4 pt-2">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">
              Pustaka Pintar
            </h2>
            <div class="flex gap-2 overflow-x-auto hide-scroll">
              <button
                onclick="renderLibrary('all')"
                class="px-5 py-2 rounded-full bg-primary text-white font-bold text-sm shadow-lg shadow-green-500/30 whitespace-nowrap"
              >
                Untukmu
              </button>
              <button
                onclick="renderLibrary('recipe')"
                class="px-5 py-2 rounded-full bg-white dark:bg-darkCard border border-gray-200 dark:border-gray-700 font-bold text-sm whitespace-nowrap"
              >
                Resep
              </button>
              <button
                onclick="renderLibrary('article')"
                class="px-5 py-2 rounded-full bg-white dark:bg-darkCard border border-gray-200 dark:border-gray-700 font-bold text-sm whitespace-nowrap"
              >
                Olahraga
              </button>
              <button
                onclick="renderLibrary('saved')"
                class="px-5 py-2 rounded-full bg-white dark:bg-darkCard border border-gray-200 dark:border-gray-700 font-bold text-sm whitespace-nowrap text-secondary"
              >
                <i class="fas fa-bookmark mr-1"></i> Disimpan
              </button>
            </div>
          </div>
          <div id="library-content" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="page-chat" class="page-section hidden h-[85vh] flex flex-col">
          <div
            class="bg-gradient-to-r from-secondary to-blue-600 p-6 rounded-b-[2rem] shadow-lg mb-4 text-white"
          >
            <div class="flex items-center gap-4">
              <div
                class="mascot-avatar bg-white/20 rounded-full w-12 h-12 flex items-center justify-center backdrop-blur-md text-2xl"
              >
                ðŸ¤–
              </div>
              <div>
                <h3 class="font-bold text-lg">Alvi Assistant</h3>
                <p class="text-xs opacity-90">Konsultan Diet Pribadi</p>
              </div>
            </div>
          </div>
          <div id="chat-box" class="flex-1 overflow-y-auto px-4 space-y-4 pb-4">
            <div class="flex gap-3">
              <div
                class="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-white text-xs font-bold"
              >
                AI
              </div>
              <div
                class="bg-white dark:bg-darkCard p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 dark:border-gray-700 max-w-[80%]"
              >
                Halo! Saya Alvi. Ada yang bisa saya bantu terkait target berat
                badanmu?
              </div>
            </div>
          </div>
          <div
            class="p-4 bg-white dark:bg-darkCard border-t border-gray-200 dark:border-gray-700"
          >
            <div
              class="flex gap-2 bg-gray-100 dark:bg-gray-700 p-2 rounded-full"
            >
              <input
                type="text"
                id="chat-input"
                placeholder="Tulis pesan..."
                class="bg-transparent flex-1 px-3 outline-none text-sm dark:text-white"
              /><button
                onclick="sendMessage()"
                class="w-10 h-10 bg-secondary rounded-full text-white flex items-center justify-center shadow-lg"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="page-profile" class="page-section hidden fade-in">
          <div class="text-center mb-8 pt-4">
            <div
              class="w-28 h-28 mx-auto bg-gray-200 rounded-full p-1 border-4 border-white dark:border-gray-700 shadow-xl mb-3 overflow-hidden"
            >
              <img
                src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix"
                class="w-full h-full object-cover"
              />
            </div>
            <h2 class="text-2xl font-bold dark:text-white" id="profile-name">
              User Name
            </h2>
            <p class="text-sm text-primary font-bold">Health Warrior</p>
          </div>
          <div class="space-y-4">
            <div
              class="bg-white dark:bg-darkCard rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer btn-press"
              onclick="openOnboarding()"
            >
              <div class="flex items-center gap-4">
                <div
                  class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"
                >
                  <i class="fas fa-ruler-combined"></i>
                </div>
                <div>
                  <h4 class="font-bold text-sm">Data Fisik & Target</h4>
                  <p class="text-xs text-gray-500">
                    Ubah berat, tinggi, dan tujuan
                  </p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-gray-300"></i>
            </div>
            <button
              onclick="location.reload()"
              class="w-full bg-red-50 text-red-500 font-bold py-4 rounded-2xl mt-4 border border-red-100 hover:bg-red-100 transition"
            >
              Keluar Akun
            </button>
          </div>
        </div>
      </main>

      <nav
        class="fixed bottom-0 w-full bg-white dark:bg-darkCard border-t border-gray-200 dark:border-gray-800 flex justify-around py-3 z-40 pb-6 md:pb-3 max-w-md mx-auto left-0 right-0 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]"
      >
        <button
          onclick="showPage('home')"
          class="nav-btn active flex flex-col items-center gap-1 text-primary w-12 transition-all"
        >
          <i class="fas fa-home text-xl mb-0.5"></i
          ><span class="text-[10px] font-bold">Home</span>
        </button>
        <button
          onclick="showPage('stats')"
          class="nav-btn flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 w-12 transition-all"
        >
          <i class="fas fa-chart-pie text-xl mb-0.5"></i
          ><span class="text-[10px] font-bold">Stats</span>
        </button>
        <div class="relative -top-8 group">
          <button
            onclick="startScanFlow()"
            class="w-16 h-16 bg-primary rounded-full text-white shadow-xl shadow-green-500/40 flex items-center justify-center border-[5px] border-surface dark:border-darkBg btn-press transform transition group-hover:scale-105 group-hover:rotate-12"
          >
            <i class="fas fa-camera text-2xl"></i>
          </button>
        </div>
        <button
          onclick="showPage('library')"
          class="nav-btn flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 w-12 transition-all"
        >
          <i class="fas fa-book-open text-xl mb-0.5"></i
          ><span class="text-[10px] font-bold">Info</span>
        </button>
        <button
          onclick="showPage('chat')"
          class="nav-btn flex flex-col items-center gap-1 text-gray-400 dark:text-gray-500 w-12 transition-all"
        >
          <i class="fas fa-comments text-xl mb-0.5"></i
          ><span class="text-[10px] font-bold">Chat</span>
        </button>
      </nav>
    </div>

    <div
      id="data-modal"
      class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white dark:bg-darkCard rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl animate-bounce-in"
      >
        <div
          class="bg-gradient-to-r from-primary to-green-400 p-6 text-white text-center"
        >
          <h3 class="font-bold text-xl">Lengkapi Profil</h3>
          <p class="text-xs opacity-90">Agar target nutrisi akurat</p>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4 input-group">
            <div>
              <label class="text-xs font-bold text-gray-500">Berat (kg)</label
              ><input type="number" id="input-weight" class="text-center" />
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500">Tinggi (cm)</label
              ><input type="number" id="input-height" class="text-center" />
            </div>
          </div>
          <div class="input-group">
            <label class="text-xs font-bold text-gray-500">Usia</label
            ><input type="number" id="input-age" class="text-center" />
          </div>
          <div class="input-group">
            <label class="text-xs font-bold text-gray-500"
              >Target Kesehatan</label
            ><select id="input-goal" onchange="updateGoalInfo()">
              <option value="lose">Turunkan Berat Badan</option>
              <option value="gain">Naikkan Berat Badan</option>
              <option value="maintain">Jaga Berat Badan</option>
            </select>
            <div
              id="goal-info"
              class="mt-2 p-3 bg-blue-50 dark:bg-slate-800 rounded-xl text-[10px] text-gray-600 dark:text-gray-300 border border-blue-100 dark:border-slate-700"
            >
              <i class="fas fa-info-circle text-blue-500 mr-1"></i> Defisit
              kalori aman untuk hasil jangka panjang.
            </div>
          </div>
          <div class="flex gap-3">
            <button
              onclick="selectGender('male')"
              id="btn-male"
              class="flex-1 py-3 rounded-2xl border-2 font-bold text-sm text-gray-400 transition"
            >
              Pria</button
            ><button
              onclick="selectGender('female')"
              id="btn-female"
              class="flex-1 py-3 rounded-2xl border-2 font-bold text-sm text-gray-400 transition"
            >
              Wanita
            </button>
          </div>
          <button
            onclick="saveUserData()"
            class="w-full bg-primary text-white font-bold py-4 rounded-xl mt-2 shadow-lg btn-press"
          >
            SIMPAN & HITUNG
          </button>
        </div>
      </div>
    </div>
    <div
      id="daily-modal"
      class="fixed inset-0 bg-black/80 z-[65] hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white dark:bg-darkCard rounded-[2rem] w-full max-w-xs p-6 shadow-2xl text-center"
      >
        <div class="mascot-avatar mb-2">ðŸ¥‘</div>
        <h3 class="font-bold text-lg mb-2">Check-in Harian ðŸ“…</h3>
        <p class="text-xs text-gray-500 mb-4">
          Sudah nimbang berat badan pagi ini?
        </p>
        <input
          type="number"
          id="daily-weight"
          class="input-group w-full p-3 rounded-xl border text-center text-xl font-bold mb-4"
          placeholder="kg"
        /><button
          onclick="saveDailyCheckin()"
          class="w-full bg-secondary text-white font-bold py-3 rounded-xl btn-press"
        >
          Update Data</button
        ><button
          onclick="document.getElementById('daily-modal').classList.add('hidden')"
          class="text-xs text-gray-400 mt-3 underline"
        >
          Nanti Saja
        </button>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 bg-black/80 z-[90] hidden flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white dark:bg-darkCard w-full max-w-sm rounded-t-[2rem] sm:rounded-[2rem] overflow-hidden shadow-2xl slide-up max-h-[90vh] overflow-y-auto flex flex-col"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="font-bold text-xl dark:text-white">Hasil Scan AI</h3>
              <p class="text-xs text-green-600 font-bold">
                Terdeteksi 3 Komponen
              </p>
            </div>
            <button
              onclick="document.getElementById('confirm-modal').classList.add('hidden')"
              class="text-gray-400"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div id="scan-items-container" class="space-y-4 mb-6"></div>

          <div
            class="bg-blue-50 dark:bg-slate-800 p-4 rounded-xl border border-blue-100 dark:border-slate-700 mb-4"
          >
            <div
              class="flex justify-between font-bold text-sm text-gray-800 dark:text-white"
            >
              <span>Total Kalori:</span
              ><span id="scan-total-display">0 kkal</span>
            </div>
          </div>

          <button
            onclick="saveFood()"
            class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg btn-press"
          >
            Konfirmasi & Lanjut
          </button>
        </div>
      </div>
    </div>

    <div
      id="result-modal"
      class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-6 backdrop-blur-md"
    >
      <div
        class="bg-white dark:bg-darkCard rounded-[2rem] w-full max-w-sm p-6 shadow-2xl animate-bounce-in relative max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-xl dark:text-white">Analisis Nutrisi</h3>
          <div
            class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs font-bold border border-gray-300"
          >
            Grade: <span class="text-green-600">B+</span>
          </div>
        </div>

        <div class="mb-4 h-40 w-full relative">
          <canvas id="radarChart"></canvas>
        </div>

        <div class="mb-4">
          <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">
            Nutri-Score
          </p>
          <div class="nutri-score-bar">
            <div class="ns-seg ns-a"></div>
            <div class="ns-seg ns-b active"></div>
            <div class="ns-seg ns-c"></div>
            <div class="ns-seg ns-d"></div>
            <div class="ns-seg ns-e"></div>
          </div>
        </div>

        <div
          class="bg-blue-50 dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-blue-100 dark:border-slate-700 mb-4"
        >
          <div
            class="flex items-center gap-2 mb-2 text-blue-600 font-bold text-sm"
          >
            <i class="fas fa-lightbulb"></i> Insight Nutrisi
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs mb-2">
            <div class="flex items-center gap-1 text-green-600">
              <i class="fas fa-check-circle"></i> Tinggi Protein
            </div>
            <div class="flex items-center gap-1 text-orange-500">
              <i class="fas fa-exclamation-circle"></i> Rendah Serat
            </div>
          </div>
          <div
            class="grid grid-cols-2 gap-2 text-xs border-t border-blue-200 pt-2"
          >
            <div>
              Gula: <span class="font-bold text-green-600">Rendah</span>
            </div>
            <div>
              Garam: <span class="font-bold text-yellow-600">Sedang</span>
            </div>
          </div>
        </div>

        <div
          id="advice-box"
          class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 mb-4 text-left"
        >
          <div class="flex items-center gap-2 mb-2">
            <div class="mascot-avatar text-xl">ðŸ¥‘</div>
            <span class="font-bold text-sm">Saran Alvi:</span>
          </div>
          <p
            class="text-xs text-gray-600 dark:text-gray-300 leading-relaxed"
            id="anl-advice"
          >
            Pilihan yang enak! Karena seratnya agak kurang, gimana kalau nanti
            malam kita makan buah atau sayur tumis?
          </p>
        </div>

        <div class="border-t border-gray-100 dark:border-gray-700 pt-4 mb-4">
          <div class="flex justify-between text-sm mb-1">
            <span class="text-gray-500">Sisa Kalori Harian:</span
            ><span class="font-bold text-gray-900 dark:text-white" id="anl-rem"
              >0 kkal</span
            >
          </div>
          <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
            <div id="anl-bar" class="bg-primary h-full" style="width: 0%"></div>
          </div>
        </div>

        <button
          onclick="finishFlow()"
          class="w-full bg-primary text-white font-bold py-3 rounded-xl btn-press"
        >
          Simpan ke Jurnal
        </button>
      </div>
    </div>

    <div
      id="camera-overlay"
      class="fixed inset-0 bg-black z-[70] hidden flex flex-col"
    >
      <div class="relative flex-1 bg-gray-900 overflow-hidden">
        <img
          src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&q=80"
          class="w-full h-full object-cover opacity-60 scale-110"
          alt="Camera"
        />
        <div class="absolute inset-0 flex items-center justify-center">
          <div
            class="w-72 h-72 border-2 border-primary rounded-[2rem] relative shadow-[0_0_0_1000px_rgba(0,0,0,0.5)]"
          >
            <div
              class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white/80 font-bold text-sm tracking-widest animate-pulse"
            >
              AI SCANNING...
            </div>
          </div>
        </div>
        <button
          onclick="closeCamera()"
          class="absolute top-8 right-6 text-white text-3xl drop-shadow-md"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="h-40 bg-black flex items-center justify-center pb-4">
        <button
          onclick="captureImage()"
          class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center btn-press shadow-lg shadow-white/20"
        >
          <div class="w-16 h-16 bg-white rounded-full"></div>
        </button>
      </div>
    </div>
    <div
      id="detail-modal"
      class="fixed inset-0 bg-surface dark:bg-darkBg z-[130] hidden overflow-y-auto pb-20"
    ></div>

    <script>
      // --- DATA ---
      let appState = {
        user: {
          name: "",
          weight: 0,
          height: 0,
          age: 0,
          gender: "",
          goal: "lose",
          bmi: 0,
          tdee: 0,
          ideal: 0,
        },
        daily: { calories: 0, protein: 0, carbs: 0, fat: 0, history: [] },
        history: { weights: [], calories: [], dates: [] },
        weightLog: [],
        savedRecipes: [],
        scanItems: [],
        streak: 3,
        statMode: "calorie",
      };

      const contentDB = {
        recipes: {
          lose: [
            {
              id: 1,
              title: "Tumis Tempe Kacang",
              cal: 180,
              img: "https://images.unsplash.com/photo-1626508035297-00324327150d?w=400",
              type: "Resep",
              ingredients: ["Tempe", "Kacang Panjang"],
              instructions: ["Tumis semua bahan"],
            },
            {
              id: 2,
              title: "Salad Tuna Telur",
              cal: 320,
              img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400",
              type: "Resep",
              ingredients: ["Tuna kaleng", "Telur rebus", "Selada"],
              instructions: ["Campur semua", "Beri dressing"],
            },
          ],
          gain: [
            {
              id: 3,
              title: "Beef Steak",
              cal: 600,
              img: "https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400",
              type: "Resep",
              ingredients: ["Daging Sapi", "Kentang"],
              instructions: ["Grill daging", "Rebus kentang"],
            },
          ],
          maintain: [
            {
              id: 4,
              title: "Soto Ayam",
              cal: 350,
              img: "https://images.unsplash.com/photo-1572656631137-7935297eff55?w=400",
              type: "Resep",
              ingredients: ["Ayam", "Kuah"],
              instructions: ["Rebus ayam", "Sajikan"],
            },
          ],
        },
        articles: {
          lose: [
            {
              title: "HIIT: Bakar Lemak",
              img: "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=400",
              type: "Artikel",
              content: "Cardio intensitas tinggi.",
            },
          ],
          gain: [
            {
              title: "Hypertrophy Guide",
              img: "https://images.unsplash.com/photo-1581009146145-b5ef050c2e1e?w=400",
              type: "Artikel",
              content: "Angkat beban berat.",
            },
          ],
        },
      };

      // --- AUTH ---
      function toggleAuth(id) {
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("register-form").classList.add("hidden");
        document.getElementById(id + "-form").classList.remove("hidden");
      }
      function handleLogin() {
        enterApp("Budi Santoso");
      }
      function handleRegister() {
        const name = document.getElementById("reg-name").value;
        const pass = document.getElementById("reg-pass").value;
        const conf = document.getElementById("reg-pass-confirm").value;
        if (!name || pass.length < 8 || pass !== conf)
          return showToast("Data tidak valid!", "error");
        enterApp(name);
      }
      function enterApp(name) {
        appState.user.name = name;
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("app-dashboard").classList.remove("hidden");
        document.getElementById("home-username").innerText = name.split(" ")[0];
        document.getElementById("profile-name").innerText = name;
        document.getElementById("streak-count").innerText = appState.streak;
        if (appState.user.weight === 0)
          setTimeout(
            () =>
              document.getElementById("data-modal").classList.remove("hidden"),
            500
          );
        else checkDaily();
      }

      // --- ONBOARDING & DAILY ---
      function updateGoalInfo() {
        const goal = document.getElementById("input-goal").value;
        const txt =
          goal === "lose"
            ? "Fokus: Defisit Kalori & Cardio."
            : goal === "gain"
            ? "Fokus: Surplus Kalori & Protein."
            : "Fokus: Nutrisi Seimbang.";
        document.getElementById(
          "goal-info"
        ).innerHTML = `<i class="fas fa-info-circle text-blue-500 mr-1"></i> ${txt}`;
      }
      let selectedGender = "";
      function selectGender(g) {
        selectedGender = g;
        document
          .querySelectorAll("#btn-male, #btn-female")
          .forEach(
            (b) =>
              (b.className =
                "flex-1 py-3 rounded-2xl border-2 font-bold text-sm text-gray-400")
          );
        document.getElementById("btn-" + g).className =
          "flex-1 py-3 rounded-2xl border-2 font-bold text-sm border-primary bg-green-50 text-primary";
      }

      function saveUserData() {
        const w = parseFloat(document.getElementById("input-weight").value);
        const h = parseFloat(document.getElementById("input-height").value);
        const a = parseFloat(document.getElementById("input-age").value);
        const goal = document.getElementById("input-goal").value;
        if (!w || !h || !a || !selectedGender)
          return showToast("Lengkapi data!", "error");

        const bmi = (w / (h / 100) ** 2).toFixed(1);
        let tdee =
          Math.round(
            (10 * w +
              6.25 * h -
              5 * a +
              (selectedGender === "male" ? 5 : -161)) *
              1.375
          ) + (goal === "lose" ? -500 : goal === "gain" ? 500 : 0);
        let ideal = Math.round(
          h - 100 - (h - 100) * (selectedGender === "male" ? 0.1 : 0.15)
        );

        appState.user = {
          ...appState.user,
          weight: w,
          height: h,
          age: a,
          gender: selectedGender,
          goal: goal,
          bmi: bmi,
          tdee: tdee,
          ideal: ideal,
        };
        appState.history.weights = [w - 2, w - 1.5, w - 1, w - 0.5, w];
        appState.history.calories = [
          tdee - 200,
          tdee + 100,
          tdee - 50,
          tdee,
          tdee - 100,
        ];
        appState.history.dates = ["Sen", "Sel", "Rab", "Kam", "Jum"];
        appState.weightLog.push({ date: "Hari Ini", weight: w, bmi: bmi });

        document.getElementById("data-modal").classList.add("hidden");
        checkDaily();
      }

      function checkDaily() {
        setTimeout(
          () =>
            document.getElementById("daily-modal").classList.remove("hidden"),
          500
        );
        initDashboard();
      }
      function saveDailyCheckin() {
        const w = parseFloat(document.getElementById("daily-weight").value);
        if (w) {
          appState.user.weight = w;
          appState.user.bmi = (w / (appState.user.height / 100) ** 2).toFixed(
            1
          );
          appState.history.weights.push(w);
          appState.history.weights.shift();
          appState.weightLog.unshift({
            date: "Hari Ini",
            weight: w,
            bmi: appState.user.bmi,
          });
          showToast("Berat badan diupdate!");
        }
        document.getElementById("daily-modal").classList.add("hidden");
        initDashboard();
      }

      // --- DASHBOARD ---
      function initDashboard() {
        document.getElementById(
          "medical-context"
        ).innerHTML = `Halo! Berdasarkan TB <b>${appState.user.height}cm</b> & BB <b>${appState.user.weight}kg</b>, tubuhmu butuh asupan spesifik.`;
        document.getElementById("ctx-cal").innerText =
          appState.user.tdee + " kkal";
        document.getElementById("ctx-ideal").innerText =
          appState.user.ideal + " kg";
        updateHomeStats();
        renderCharts();
        renderLibrary("all");
      }
      function updateHomeStats() {
        const rem = appState.user.tdee - appState.daily.calories;
        document.getElementById("home-remaining-cals").innerText = rem;
        document.getElementById("cal-circle").style.strokeDashoffset =
          175 -
          (175 *
            Math.min(
              (appState.daily.calories / appState.user.tdee) * 100,
              100
            )) /
            100;
        document.getElementById("home-pro").innerText =
          appState.daily.protein + "g";
        document.getElementById("home-car").innerText =
          appState.daily.carbs + "g";
        document.getElementById("home-fat").innerText =
          appState.daily.fat + "g";
      }

      // --- CHARTS ---
      let chartInstance;
      function updateStatsView(mode) {
        appState.statMode = mode;
        document.getElementById(
          "stat-tab-cal"
        ).className = `flex-1 py-2 rounded-lg text-sm font-bold transition ${
          mode === "calorie"
            ? "bg-white text-primary shadow-sm"
            : "text-gray-500"
        }`;
        document.getElementById(
          "stat-tab-wei"
        ).className = `flex-1 py-2 rounded-lg text-sm font-bold transition ${
          mode === "weight"
            ? "bg-white text-primary shadow-sm"
            : "text-gray-500"
        }`;
        renderCharts();
        renderHistoryList();
      }
      function renderCharts() {
        const ctx = document.getElementById("mainChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        let data =
          appState.statMode === "calorie"
            ? appState.history.calories
            : appState.history.weights;
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: appState.history.dates,
            datasets: [
              {
                label: appState.statMode,
                data: data,
                borderColor:
                  appState.statMode === "calorie" ? "#58CC02" : "#1CB0F6",
                backgroundColor:
                  appState.statMode === "calorie" ? "#58CC0220" : "#1CB0F620",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { grid: { display: false } },
              x: { grid: { display: false } },
            },
          },
        });
        renderHistoryList();
      }
      function renderHistoryList() {
        const list = document.getElementById("history-list");
        list.innerHTML = "";
        if (appState.statMode === "calorie") {
          if (appState.daily.history.length === 0)
            list.innerHTML = `<div class="text-center text-gray-400 text-sm">Belum ada makanan.</div>`;
          appState.daily.history.forEach((item) => {
            list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-xl"><div><p class="font-bold text-sm dark:text-white">${item.name}</p><p class="text-xs text-gray-500">${item.time}</p></div><span class="font-bold text-primary">${item.cal} kkal</span></div>`;
          });
        } else {
          appState.weightLog.forEach((log) => {
            list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-xl"><div><p class="font-bold text-sm dark:text-white">${log.date}</p><p class="text-xs text-gray-500">Tinggi: ${appState.user.height} cm</p></div><div class="text-right"><p class="font-bold text-secondary">${log.weight} kg</p><p class="text-xs text-gray-500">BMI: ${log.bmi}</p></div></div>`;
          });
        }
      }
      function updateWeight() {
        const val = parseFloat(
          document.getElementById("quick-weight-input").value
        );
        if (val) {
          appState.history.weights.push(val);
          appState.history.dates.push("Now");
          appState.history.weights.shift();
          appState.history.dates.shift();
          appState.user.weight = val;
          renderCharts();
          showToast("Berat disimpan!");
        }
      }

      // --- SCAN FLOW (Editable + Auto Total + Merged Result) ---
      function startScanFlow() {
        document.getElementById("camera-overlay").classList.remove("hidden");
      }
      function closeCamera() {
        document.getElementById("camera-overlay").classList.add("hidden");
      }
      function captureImage() {
        closeCamera();
        showToast("AI Menganalisis...", "info");
        setTimeout(() => {
          appState.scanItems = [
            { name: "Nasi Putih", cal: 130, pro: 2, car: 28, fat: 0 },
            { name: "Ayam Goreng", cal: 200, pro: 18, car: 5, fat: 12 },
            { name: "Sayur Asem", cal: 50, pro: 1, car: 8, fat: 2 },
          ];
          renderScanConfirmation();
          document.getElementById("confirm-modal").classList.remove("hidden");
        }, 1500);
      }

      function renderScanConfirmation() {
        const container = document.getElementById("scan-items-container");
        container.innerHTML = "";
        let total = 0;
        appState.scanItems.forEach((i, index) => {
          total += i.cal;
          // Updated HTML structure with inputs
          container.innerHTML += `
            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm mb-3 flex justify-between items-center relative">
                <div class="flex-1 mr-4">
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1 block">Nama Makanan</label>
                    <input type="text" id="edit-name-${index}" value="${i.name}" class="w-full font-bold text-gray-800 dark:text-white bg-transparent border-b border-dashed border-gray-300 focus:border-primary focus:outline-none transition-colors pb-1">
                    <p class="text-[10px] text-gray-500 mt-1">P:${i.pro} C:${i.car} F:${i.fat}</p>
                </div>
                <div class="text-right">
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1 block">Kkal</label>
                    <input type="number" id="edit-cal-${index}" value="${i.cal}" onchange="updateTotalCal()" class="w-16 font-bold text-primary text-right bg-transparent border-b border-dashed border-gray-300 focus:border-primary focus:outline-none pb-1">
                </div>
            </div>`;
        });
        document.getElementById("scan-total-display").innerText =
          total + " kkal";
      }

      function updateTotalCal() {
        let newTotal = 0;
        appState.scanItems.forEach((_, index) => {
          const val = parseFloat(
            document.getElementById(`edit-cal-${index}`).value
          );
          newTotal += isNaN(val) ? 0 : val;
        });
        document.getElementById("scan-total-display").innerText =
          newTotal + " kkal";
      }

      function saveFood() {
        // Read values from inputs before saving
        appState.scanItems.forEach((_, index) => {
          appState.scanItems[index].name = document.getElementById(
            `edit-name-${index}`
          ).value;
          appState.scanItems[index].cal = parseFloat(
            document.getElementById(`edit-cal-${index}`).value
          );
        });

        document.getElementById("confirm-modal").classList.add("hidden");
        showMergedResult();
      }

      let radarChart;
      function showMergedResult() {
        // Calc Totals based on possibly edited values
        let tot = { cal: 0, pro: 0, car: 0, fat: 0 };
        appState.scanItems.forEach((i) => {
          tot.cal += i.cal;
          tot.pro += i.pro;
          tot.car += i.car;
          tot.fat += i.fat;
        });

        // Empathetic Logic Advice
        let advice = "Nutrisimu seimbang. Kerja bagus!";
        if (tot.fat > 20)
          advice =
            "Pilihan yang enak! Namun lemaknya agak tinggi. Coba seimbangkan dengan makan sayur rebus nanti malam ya.";
        else if (tot.car > 80)
          advice =
            "Energi yang besar! Karena karbohidratnya tinggi, yuk sempatkan jalan kaki sebentar agar tidak jadi lemak.";
        else if (tot.pro < 10)
          advice =
            "Rasanya kurang lengkap tanpa protein. Nanti tambah telur atau tempe di cemilanmu ya!";
        document.getElementById("anl-advice").innerText = advice;

        const remaining =
          appState.user.tdee - (appState.daily.calories + tot.cal);
        document.getElementById("anl-rem").innerText = remaining + " kkal";
        document.getElementById("anl-bar").style.width =
          Math.min(
            ((appState.daily.calories + tot.cal) / appState.user.tdee) * 100,
            100
          ) + "%";

        // Render Radar
        const ctxR = document.getElementById("radarChart").getContext("2d");
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctxR, {
          type: "radar",
          data: {
            labels: ["Protein", "Karbo", "Lemak", "Serat", "Vitamin"],
            datasets: [
              {
                label: "Komposisi Makanan",
                data: [tot.pro, tot.car, tot.fat, 5, 8], // Dummy fiber/vit
                backgroundColor: "rgba(88, 204, 2, 0.2)",
                borderColor: "#58CC02",
                pointBackgroundColor: "#58CC02",
              },
            ],
          },
          options: {
            elements: { line: { borderWidth: 3 } },
            scales: {
              r: {
                ticks: { display: false },
                grid: { color: "#e5e5e5" },
              },
            },
          },
        });

        document.getElementById("result-modal").classList.remove("hidden");
      }

      function finishFlow() {
        let tot = { cal: 0, pro: 0, car: 0, fat: 0 };
        appState.scanItems.forEach((i) => {
          tot.cal += i.cal;
          tot.pro += i.pro;
          tot.car += i.car;
          tot.fat += i.fat;
        });
        appState.daily.calories += tot.cal;
        appState.daily.protein += tot.pro;
        appState.daily.carbs += tot.car;
        appState.daily.fat += tot.fat;
        appState.daily.history.push({
          name: "Makan Siang (Scan)",
          cal: tot.cal,
          time: new Date().toLocaleTimeString().slice(0, 5),
        });
        document.getElementById("result-modal").classList.add("hidden");
        initDashboard();
        showToast("Data tersimpan!");
      }

      // --- MENU & LIBRARY ---
      function generateMealPlan() {
        const goal = appState.user.goal || "lose";
        const list = contentDB.recipes[goal] || [];
        const container = document.getElementById("meal-plan-container");
        container.innerHTML = "";
        list.slice(0, 3).forEach((r) => {
          container.innerHTML += `<div class="bg-white dark:bg-darkCard p-3 rounded-2xl border border-gray-100 dark:border-gray-700 flex gap-3 items-center btn-press cursor-pointer" onclick="openDetail('${r.title}')"><img src="${r.img}" class="w-14 h-14 rounded-xl object-cover"><div class="flex-1"><h4 class="font-bold text-sm dark:text-white line-clamp-1">${r.title}</h4><p class="text-xs text-primary font-bold">${r.cal} kkal</p></div><i class="fas fa-chevron-right text-gray-300"></i></div>`;
        });
        showToast("Menu berhasil dibuat!");
      }
      function renderLibrary(filter) {
        const container = document.getElementById("library-content");
        container.innerHTML = "";
        let items = [];
        const goal = appState.user.goal || "lose";
        if (filter === "all" || filter === "recipe")
          items = [...(contentDB.recipes[goal] || [])];
        if (filter === "all" || filter === "article")
          items = [...items, ...(contentDB.articles[goal] || [])];
        if (filter === "saved") items = appState.savedRecipes;
        items.forEach((item) => {
          container.innerHTML += `<div class="bg-white dark:bg-darkCard rounded-2xl overflow-hidden shadow-sm border border-gray-100 dark:border-gray-700 btn-press cursor-pointer relative" onclick="openDetail('${
            item.title
          }')"><div class="h-32 bg-gray-200 relative"><img src="${
            item.img
          }" class="w-full h-full object-cover"><span class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-lg backdrop-blur">${
            item.type || "Resep"
          }</span></div><div class="p-3"><h4 class="font-bold text-xs dark:text-white line-clamp-2">${
            item.title
          }</h4></div></div>`;
        });
      }
      function openDetail(title) {
        let item;
        Object.values(contentDB.recipes)
          .flat()
          .forEach((r) => {
            if (r.title === title) item = { ...r, type: "Resep" };
          });
        Object.values(contentDB.articles)
          .flat()
          .forEach((a) => {
            if (a.title === title) item = { ...a, type: "Artikel" };
          });
        if (!item) return;
        const isSaved = appState.savedRecipes.find(
          (r) => r.title === item.title
        );
        const modal = document.getElementById("detail-modal");
        modal.innerHTML = `<div class="relative h-72"><img src="${
          item.img
        }" class="w-full h-full object-cover"><button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="absolute top-4 left-4 bg-white/30 backdrop-blur p-2 rounded-full text-white"><i class="fas fa-arrow-left"></i></button>${
          item.type === "Resep"
            ? `<button onclick="toggleSave('${
                item.title
              }')" class="absolute top-4 right-4 bg-white p-2 rounded-full shadow-lg ${
                isSaved ? "text-primary" : "text-gray-400"
              }"><i class="fas fa-bookmark"></i></button>`
            : ""
        }</div><div class="bg-surface dark:bg-darkBg relative -top-6 rounded-t-[2rem] p-6 min-h-screen"><h2 class="text-2xl font-bold dark:text-white mb-2">${
          item.title
        }</h2>${
          item.type === "Resep"
            ? `<div class="flex gap-3 mb-6"><span class="bg-green-100 text-primary px-3 py-1 rounded-full text-xs font-bold">${
                item.cal
              } kkal</span></div><h3 class="font-bold text-lg mb-3 dark:text-white">Bahan</h3><ul class="list-disc pl-5 text-sm text-gray-600 dark:text-gray-300 mb-4">${item.ingredients
                .map((i) => `<li>${i}</li>`)
                .join(
                  ""
                )}</ul><h3 class="font-bold text-lg mb-3 dark:text-white">Instruksi</h3><ol class="list-decimal pl-5 text-sm text-gray-600 dark:text-gray-300">${item.instructions
                .map((i) => `<li>${i}</li>`)
                .join("")}</ol>`
            : `<p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">${item.content}</p>`
        }</div>`;
        modal.classList.remove("hidden");
      }
      function toggleSave(title) {
        const idx = appState.savedRecipes.findIndex((r) => r.title === title);
        if (idx > -1) {
          appState.savedRecipes.splice(idx, 1);
          showToast("Dihapus");
        } else {
          appState.savedRecipes.push(
            Object.values(contentDB.recipes)
              .flat()
              .find((r) => r.title === title)
          );
          showToast("Disimpan");
        }
        openDetail(title);
      }

      // --- CHAT ---
      function sendMessage() {
        const input = document.getElementById("chat-input");
        const box = document.getElementById("chat-box");
        if (!input.value) return;
        box.innerHTML += `<div class="flex gap-3 justify-end"><div class="bg-primary text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[80%]">${input.value}</div></div>`;
        input.value = "";
        setTimeout(() => {
          box.innerHTML += `<div class="flex gap-3"><div class="mascot-avatar w-8 h-8 flex items-center justify-center text-sm">ðŸ¥‘</div><div class="bg-white dark:bg-darkCard p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 dark:border-gray-700 max-w-[80%]">Saran saya: Fokus pada defisit kalori dan olahraga rutin.</div></div>`;
        }, 800);
      }

      // --- UTILS ---
      function showPage(id) {
        document
          .querySelectorAll(".page-section")
          .forEach((p) => p.classList.add("hidden"));
        document.getElementById("page-" + id).classList.remove("hidden");
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("text-primary"));
        if (id === "home")
          document
            .querySelectorAll(".nav-btn")[0]
            .classList.add("text-primary");
        if (id === "stats") {
          document
            .querySelectorAll(".nav-btn")[1]
            .classList.add("text-primary");
          renderCharts();
        }
        if (id === "library")
          document
            .querySelectorAll(".nav-btn")[2]
            .classList.add("text-primary");
        if (id === "chat")
          document
            .querySelectorAll(".nav-btn")[3]
            .classList.add("text-primary");
        window.scrollTo(0, 0);
      }
      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
      }
      function showToast(msg, type) {
        const t = document.getElementById("toast");
        document.getElementById("toast-msg").innerText = msg;
        document.getElementById("toast-icon").className =
          type === "error"
            ? "bg-red-100 text-red-500 p-2 rounded-full"
            : "bg-green-100 text-primary p-2 rounded-full";
        t.classList.remove("opacity-0", "-translate-y-5");
        setTimeout(() => t.classList.add("opacity-0", "-translate-y-5"), 3000);
      }
    </script>
  </body>
</html>
